<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Hibernate — Hibernate主键生成策略 &middot; 尹枭凌
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48740529-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="200" height="180" alt="A photo of ariestiyansyah" src="/images/head.jpeg">
    <p align="center">If I know what love is, <br />it is because of you.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">首页</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">关于我</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">分类</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">联系方式</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="https://github.com/yinxiaoling">GitHub project</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">尹枭凌</a>
            <small>—因为有了因为，所以有了所以，既然已成既然，何必再问何必。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Hibernate — Hibernate主键生成策略</h1>
  <span class="post-date">01 Aug 2015</span>
  <h2>简介：</h2>

<h4>increment：代理主键，适合于所有数据库，由hibernate维护主键自增，和底层数据库无关，但是不适合于2个或以上hibernate进程。</h4>

<h4>identity：代理主键，适合于Mysql或ms sql server等支持自增的dbms，主键值不由hibernate维护。</h4>

<h4>sequence：代理主键，适合于oracle等支持序列的dbms，主键值不由hibernate维护，由序列产生。</h4>

<h4>native：代理主键，根据底层数据库的具体特性选择适合的主键生成策略，如果是mysql或sqlserver，选择identity，如果是oracle，选择sequence。</h4>

<h4>hilo：代理主键，hibernate把特定表的字段作为hign值，生成主键值</h4>

<h4>uuid.hex：代理主键，hibernate采用uuid 128位算法生成基于字符串的主键值</h4>

<h4>assign：适合于应用程序维护的自然主键。</h4>

<h4>1、自动增长identity</h4>

<h6>适用于MySQL、DB2、MS SQL Server，采用数据库生成的主键，用于为long、short、int类型生成唯一标识使用SQL Server 和 MySQL 的自增字段，这个方法不能放到 Oracle 中，Oracle 不支持自增字段，要设定sequence（MySQL 和 SQL Server 中很常用）</h6>

<h6>数据库中的语法如下：</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">MySQL：create table t_user(id int auto_increment primary key, name varchar(20));
SQL Server：create table t_user(id int identity(1,1) primary key, name varchar(20));

&lt;id name=&quot;id&quot; column=&quot;id&quot; type=&quot;long&quot;&gt;
    &lt;generator class=&quot;identity&quot; /&gt;
&lt;/id&gt;
</code></pre></div>
<h4>2、sequence</h4>

<h6>DB2、Oracle均支持的序列，用于为long、short或int生成唯一标识</h6>

<h6>数据库中的语法如下：</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">Oracle：create sequence seq_name increment by 1 start with 1;
</code></pre></div>
<h6>需要主键值时可以调用seq<em>name.nextval或者seq</em>name.curval得到，数据库会帮助我们维护这个sequence序列，保证每次取到的值唯一，如：</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">insert into tbl_name(id, name) values(seq_name.nextval, ‘Jimliu’);

&lt;id name=&quot;id&quot; column=&quot;id&quot; type=&quot;long&quot;&gt;
    &lt;generator class=&quot;sequence&quot;&gt;
       &lt;param name=&quot;sequence&quot;&gt;seq_name&lt;/param&gt;
   &lt;/generator&gt;
&lt;/id&gt;
</code></pre></div>
<h6>如果我们没有指定sequence参数，则Hibernate会访问一个默认的sequence，是hibernate_sequence，我们也需要在数据库中建立这个sequence此外，sequence还可以有另外一个参数是paramters，可以查看Hibernate的API了解它的用法，见org.hibernate.id.SequenceGenerator调用数据库的sequence来生成主键，要设定序列名，不然hibernate无法找到：</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;param name=&quot;sequence&quot;&gt;NAME_SEQ&lt;/param&gt;（Oracle中很常用）
</code></pre></div>
<h4>3、hilo</h4>

<h6>使用一个高/低位算法生成的long、short或int类型的标识符，给定一个表和字段作为高位值的来源，默认的表是hibernate<em>unique</em>key，默认的字段是next_hi。它将id的产生源分成两部分，DB+内存，然后按照算法结合在一起产生id值，可以在很少的连接次数内产生多条记录，提高效率</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">MySQL：create table hi_value(next_hi integer not null);

insert into hi_value(next_hi) values(1);

&lt;id name=&quot;id&quot; column=&quot;id&quot;&gt;
    &lt;generator class=&quot;hilo&quot;&gt;
       &lt;param name=&quot;table&quot;&gt;hi_value&lt;/param&gt;
       &lt;param name=&quot;column&quot;&gt;next_hi&lt;/param&gt;
       &lt;param name=&quot;max_lo&quot;&gt;100&lt;/param&gt;
   &lt;/generator&gt;
&lt;/id&gt;
</code></pre></div>
<h6>在hibernate持久化的时候，由hibernate负责生成低位值。hilo标识符生成器在生成标识符时需要从hi<em>value表中取出next</em>hi的当前值，然后修改该值，这个操作是在单独的事务中完成的。最大的低值在属性max<em>lo中配置，但在Hibernate内存中生成的低位值超过此值时，就有需要到数据库的hi</em>value表中再次读取高位值了使用hilo生成策略，要在数据库中建立一张额外的表，默认表名为hibernate<em>unique</em>key,默认字段为integer类型，名称是next_hi（比较少用）我们也可以自己设置自定义的表名和字段名</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; type=&quot;integer&quot;&gt;
   &lt;column name=&quot;id&quot;/&gt;
   &lt;generator class=&quot;hilo&quot;&gt;
      &lt;param name=&quot;my_unique_key&quot;/&gt;
      &lt;param column=&quot;next_hi&quot;/&gt;
   &lt;/generator&gt;
&lt;/id&gt;
</code></pre></div>
<h4>4、native</h4>

<h6>会根据底层数据库的能力，从identity、sequence、hilo中选择一个，灵活性更强，但此时，如果选择sequence或者hilo，则所有的表的主键都会从Hibernate默认的sequence或者hilo表中取。并且，有的数据库对于默认情况主键生成测试的支持，效率并不是很高对于 oracle 采用 Sequence 方式，对于MySQL 和 SQL Server 采用identity（自增主键生成机制），native就是将主键的生成工作交由数据库完成，hibernate不管（很常用）</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; column=&quot;id&quot;&gt;
    &lt;generator class=&quot;native&quot; /&gt;
&lt;/id&gt;
</code></pre></div>
<h4>5、seqhilo</h4>

<h6>sequence和hilo的结合，hilo的高位由sequence产生，所以也需要底层数据库的支持通过hilo算法实现，但是主键历史保存在Sequence中，适用于支持 Sequence 的数据库，如 Oracle（比较少用）</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; column=&quot;id&quot;&gt;
   &lt;generator class=&quot;seqhilo&quot;&gt;
      &lt;param name=&quot;sequence&quot;&gt;seq_name&lt;/param&gt;
      &lt;param name=&quot;max_lo&quot;&gt;100&lt;/param&gt;
   &lt;/generator&gt;
&lt;/id&gt;
</code></pre></div>
<h4>6、increment</h4>

<h6>这个是由Hibernate在内存中生成主键，每次增量为1，不依赖于底层的数据库，因此所有的数据库都可以使用，但问题也随之而来，由于是Hibernate生成的，所以只能有一个Hibernate应用进程访问数据库，否则就会产生主键冲突，不能在集群情况下使用插入数据的时候hibernate会给主键添加一个自增的主键，但是一个hibernate实例就维护一个计数器，所以在多个实例运行的时候不能使用这个方法</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; column=&quot;id&quot;&gt;
    &lt;generator class=&quot;increment&quot; /&gt;
&lt;/id&gt;
</code></pre></div>
<h4>7、uuid.hex</h4>

<h6>使用一个128-bit的UUID算法生成字符串类型的标识符，UUID被编码成一个32位16进制数字的字符串。UUID包含：IP地址、JVM启动时间、系统时间（精确到1/4秒）和一个计数器值（JVM中唯一）</h6>

<h6>hibernate会算出一个128位的唯一值插入</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; column=&quot;id&quot;&gt;
    &lt;generator class=&quot;uuid.hex&quot; /&gt;
&lt;/id&gt;


uuid.string
</code></pre></div>
<h6>hibernate会算出一个16位的值插入</h6>

<h4>8、assigned</h4>

<h6>由应用程序负责生成主键标识符，往往使用在数据库中没有代理主键，使用的主键与业务相关的情况，如：</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;id name=&quot;id&quot; column=&quot;id&quot; type=&quot;string&quot;&gt;
    &lt;generator class=&quot;assigned&quot; /&gt;
&lt;/id&gt;
</code></pre></div>
<h6>这种主键的生成方式不建议使用，在数据库表设计时就应该使用代理主键（surrogate key），不应使用自然主键（natural key具有业务含义），在没有指定<generator>标签时，默认就是assigned主键的生成方式在插入数据的时候主键由用户自己添加，hibernate也不管</h6>

<h4>9、foreign</h4>

<h6>使用外部表的字段作为主键</h6>

<h4>10、select</h4>

<h6>使用触发器生成主键（主要用于早期的数据库主键生成机制，少用）</h6>

<h4>PS:</h4>

<h6>代理主键是指与业务无关且能唯一标识数据库中记录,一般是数据库自动生成的,比如mysql可以使用auto_increment,Sql2000可以使用identity生成方式,oracle可以使用sequence生成方式 自然主键指业务相关,由用户指定,且能唯一标识数据库中的任意一条记录</h6>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/framework/2015/08/18/Java-Iocxiangjie/">
            Framework — IOC详解
            <small>18 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/java/2015/08/12/Java-HTTP-hypertext-transfer-protocol/">
            Java — HTTP 协议详解
            <small>12 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/git/2015/08/06/Git-Git-command/">
            Git — Git常用命令速查表
            <small>06 Aug 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
        Copyright © 2015 <br>
    </div>
  </body>
</html>

