<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      SQL — SQL性能优化 &middot; 尹枭凌
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48740529-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="200" height="180" alt="A photo of ariestiyansyah" src="/images/head.jpeg">
    <p align="center">If I know what love is, <br />it is because of you.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">首页</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">关于我</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">分类</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">联系方式</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="https://github.com/yinxiaoling">GitHub project</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">尹枭凌</a>
            <small>—因为有了因为，所以有了所以，既然已成既然，何必再问何必。</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">SQL — SQL性能优化</h1>
  <span class="post-date">01 Aug 2015</span>
  <h6>1.不论一个SQL中涉及到多个表，每次都用两个表（结果集）操作，得到新的结果后，再和下一个表（结果集）操作。</h6>

<hr>

<h6>2.避免在select column1，（select column2 from tableB）...form tableA;这样得到字段列，直接使用A/B关联得到column1和2就可以。</h6>

<hr>

<h6>3.避免隐含类型转换</h6>

<p>例：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee e where e.emp_id = &#39;8&#39;;

select id from employee e where e.emp_id = 8;
</code></pre></div>
<p>解释：emp_id是整数型，用&#39;8&#39;会默认启动类型转换，增加查询的开销。</p>

<hr>

<h6>4.尽量减少使用正则表达式，尽量不使用通配符</h6>

<hr>

<h6>5.使用关键字代替函数</h6>

<p>例：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee where UPPER(dept) like &#39;TECH_DB&#39;；

select id from employee where SUBSTR(dept,1,4)=&#39;TECH&#39;；

select id from employee where dept like &#39;TECH%&#39;；
</code></pre></div>
<p>这里还要说一点，除非业务硬性要求，模糊查询尽量使用前方一致。不要使用‘%%’这样的空字符串进行查询。</p>

<hr>

<h6>6.不要在字段上使用转换函数，尽量在常量上使用</h6>

<p>例：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee where to_char(create_date,&#39;yyyy-mm-dd&#39;)=&#39;2012-10-31&#39;；

select id from employee where create_date=to_date(&#39;2012-10-31&#39;,&#39;yyyy-mm-dd&#39;)；
</code></pre></div>
<hr>

<h6>7.不使用连接（||）做查询</h6>

<p>例：  </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee where first_name || last_name like &#39;Jo%&#39;；
</code></pre></div>
<hr>

<h6>8.不要对字段进行运算</h6>

<p>例：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee where creat_date-30&gt;to_date(&#39;2012-10-31&#39;,&#39;yyyy-mm-dd&#39;)；

select id from employee where creat_date &gt;to_date(&#39;2012-10-31&#39;,&#39;yyyy-mm-dd&#39;)+30;
</code></pre></div>
<p>另外强调一点：在WHERE 语句中，尽量避免对索引字段进行计算操作</p>

<hr>

<h6>9.使用exists代替in，使用not exists 代替 not in</h6>

<p>用IN写出来的SQL的优点是比较容易写及清晰易懂，这比较适合现代软件开发的风格。</p>

<p>但是用IN的SQL性能总是比较低的，从ORACLE执行的步骤来分析用IN的SQL与不用IN的SQL有以下区别：</p>

<p>ORACLE试图将其转换成多个表的连接，如果转换不成功则先执行IN里面的子查询，再查询外层的表记录，如果转换成功则直接采用多个表的连接方式查询。由此可见用IN的SQL至少多了一个转换的过程。一般的SQL都可以转换成功，但对于含有分组统计等方面的SQL就不能转换了。</p>

<p>NOT IN操作符:此操作是强列推荐不使用的，因为它不能应用表的索引。</p>

<p>推荐方案：用NOT EXISTS 或(外连接+判断为空)方案代替
例：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">select id from employee where salary in (select salary from emp_level where....)；

select id from employee where salary exists(select &#39;X&#39; from emp_level where ....)；
</code></pre></div>
<hr>

<h6>10.索引类型</h6>

<ul>
<li>唯一索引，对于查询用到的字段，尽可能使用唯一索引。</li>
<li>还有一些其他类型，如位图索引，在性别字段，只有男女的字段上用。</li>
</ul>

<hr>

<h6>11.在经常进行连接，但是没有指定为外键的列上建立索引</h6>

<hr>

<h6>12.在频繁进行排序会分组的列上建立索引，如经常做group by 或 order by 操作的字段</h6>

<hr>

<h6>13.在条件表达式中经常用到的不同值较多的列上建立检索，在不同值少的列上不建立索引</h6>

<p>例：</p>

<p>性别列上只有男，女两个不同的值，就没必要建立索引（或建立位图索引）。如果建立索引不但不会提高查询效率，反而会严重降低更新速度。</p>

<hr>

<h6>14.在值比较少的字段做order by时，翻页会出现记录紊乱问题，要带上id字段一起做order by</h6>

<hr>

<h6>15.*是禁止的</h6>

<p>在应用程序、包和过程中限制使用select * from table这种方式。看下面例子：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT empno,ename,category FROM emp WHERE empno = &#39;7369&#39;
</code></pre></div>
<p>不要使用：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT * FROM emp WHERE empno = &#39;7369&#39;
</code></pre></div>
<hr>

<h6>16.&lt;&gt; 操作符(不等于)</h6>

<p>不等于操作符是永远不会用到索引的，因此对它的处理只会产生全表扫描。</p>

<p>推荐方案：用其它相同功能的操作运算代替，如</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">a&lt;&gt;0 改为 a&gt;0 or a&lt;0

a&lt;&gt;&#39;&#39; 改为 a&gt;&#39;&#39;
</code></pre></div>
<hr>

<h6>17.IS NULL 或IS NOT NULL操作(判断字段是否为空)</h6>

<p>判断字段是否为空一般是不会应用索引的，因为B树索引是不索引空值的。</p>

<p>推荐方案：</p>

<p>用其它相同功能的操作运算代替，如</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">a is not null 改为 a&gt;0 或a&gt;&#39;&#39;等。
</code></pre></div>
<p>不允许字段为空，而用一个缺省值代替空值，如业扩申请中状态字段不允许为空，缺省为申请。</p>

<p>建立位图索引(有分区的表不能建，位图索引比较难控制，如字段值太多索引会使性能下降，多人更新操作会增加数据块锁的现象)</p>

<hr>

<h6>18.&gt; 及 &lt; 操作符(大于或小于操作符)</h6>

<p>大于或小于操作符一般情况下是不用调整的，因为它有索引就会采用索引查找，但有的情况下可以对它进行优化，如一个表有100万记录，一个数值型字段A，30万记录的A=0，30万记录的A=1，39万记录的A=2，1万记录的A=3。</p>

<p>那么执行A&gt;2与A&gt;=3的效果就有很大的区别了，因为A&gt;2时ORACLE会先找出为2的记录索引再进行比较，而A&gt;=3时ORACLE则直接找到=3的记录索引。</p>

<hr>

<h6>19.LIKE操作符</h6>

<p>LIKE操作符可以应用通配符查询，里面的通配符组合可能达到几乎是任意的查询，但是如果用得不好则会产生性能上的问题，如<code>LIKE ‘%5400%’</code> 这种查询不会引用索引，而<code>LIKE ‘X5400%’</code>则会引用范围索引。</p>

<p>一个实际例子：用YW<em>YHJBQK表中营业编号后面的户标识号可来查询营业编号 `YY</em>BH LIKE &#39;%5400%&#39;` 这个条件会产生全表扫描，如果改成</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">YY_BH LIKE &#39;X5400%&#39; OR YY_BH LIKE &#39;B5400%&#39; 
</code></pre></div>
<p>则会利用YY_BH的索引进行两个范围的查询，性能肯定大大提高。</p>

<p>尽量避免在一个复杂查询里面使用 <code>LIKE &#39;%parm1%&#39;</code>—— 会导致相关列的索引无法使用，最好不要用.</p>

<p>解决办法:</p>

<p>其实只需要对该脚本略做改进，查询速度便会提高近百倍。改进方法如下：</p>

<p>a、修改前台程序——把查询条件的供应商名称一栏由原来的文本输入改为下拉列表，用户模糊输入供应商名称时，直接在前台就帮忙定位到具体的供应商，这样在调用后台程序时，这列就可以直接用等于来关联了。</p>

<p>b、直接修改后台——根据输入条件，先查出符合条件的供应商，并把相关记录保存在一个临时表里头，然后再用临时表去做复杂关联</p>

<hr>

<h6>20.索引问题</h6>

<p>在做性能跟踪分析过程中，经常发现有不少后台程序的性能问题是因为缺少合适索引造成的，有些表甚至一个索引都没有。这种情况往往都是因为在设计表时，没去定义索引，而开发初期，由于表记录很少，索引创建与否，可能对性能没啥影响，开发人员因此也未多加重视。然一旦程序发布到生产环境，随着时间的推移，表记录越来越多</p>

<p>这时缺少索引，对性能的影响便会越来越大了。</p>

<p>这个问题需要数据库设计人员和开发人员共同关注</p>

<p>法则：不要在建立的索引的数据列上进行下列操作:</p>

<p>◆避免对索引字段进行计算操作</p>

<p>◆避免在索引字段上使用<code>not，&lt;&gt;，!=</code></p>

<p>◆避免在索引列上使用<code>IS NULL和IS NOT NULL</code></p>

<p>◆避免在索引列上出现数据类型转换</p>

<p>◆避免在索引字段上使用函数</p>

<p>◆避免建立索引的列中使用空值。</p>

<hr>

<h6>21.复杂操作</h6>

<p>部分<code>UPDATE、SELECT</code> 语句 写得很复杂（经常嵌套多级子查询）——可以考虑适当拆成几步，先生成一些临时数据表，再进行关联操作</p>

<hr>

<h6>22.UPDATE</h6>

<p>同一个表的修改在一个过程里出现好几十次，如：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">update table1
set col1=...
where col2=...;
update table1
set col1=...
where col2=...
......
</code></pre></div>
<p>这类脚本可以整合在一个<code>UPDATE</code>语句来完成.</p>

<hr>

<h6>23.在可以使用UNION ALL的语句里，使用了UNION</h6>

<p><code>UNION</code> 因为会将各查询子集的记录做比较，故比起<code>UNION ALL</code> ，通常速度都会慢上许多。</p>

<p>一般来说，如果使用<code>UNION ALL</code>能满足要求的话，务必使用<code>UNION ALL</code>。</p>

<p>还有一种情况大家可能会忽略掉，就是虽然要求几个子集的并集需要过滤掉重复记录，但由于脚本的特殊性，不可能存在重复记录，这时便应该使用<code>UNION ALL</code>.</p>

<hr>

<h6>24.1.避免在WHERE子句中使用<code>in，not  in，or</code>或者<code>having</code>。</h6>

<p>可以使用 <code>exist</code>和<code>not exist</code>代替 <code>in</code>和<code>not in</code>。</p>

<p>可以使用表链接代替 <code>exist</code>。<code>Having</code>可以用<code>where</code>代替，如果无法代替可以分两步处理。</p>

<p>例子：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT *  FROM ORDERS WHERE CUSTOMER_NAME NOT IN (SELECT CUSTOMER_NAME FROM CUSTOMER)
</code></pre></div>
<p>优化：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT *  FROM ORDERS WHERE CUSTOMER_NAME not exist (SELECT CUSTOMER_NAME FROM CUSTOMER)
</code></pre></div>
<h6>24.2.不要以字符格式声明数字，要以数字格式声明字符值。（日期同样）否则会使索引无效，产生全表扫描。</h6>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT emp.ename, emp.job FROM emp WHERE emp.empno = 7369;
</code></pre></div>
<p>不要使用：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SELECT emp.ename, emp.job FROM emp WHERE emp.empno = &#39;7369&#39;
</code></pre></div>
<hr>

<h6>25.排序</h6>

<p>避免使用耗费资源的操作，带有<code>DISTINCT,UNION,MINUS,INTERSECT,ORDER BY</code>的SQL语句会启动SQL引擎执行，耗费资源的排序(SORT)功能. </p>

<p><code>DISTINCT</code>需要一次排序操作, 而其他的至少需要执行两次排序.</p>

<hr>

<h6>26.临时表</h6>

<p>慎重使用临时表可以极大的提高系统性能.</p>

<hr>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/others/2015/08/01/other-qizongzui/">
            Others — 让你此生难成大器的七宗罪
            <small>01 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/java/2015/08/01/other-PG-10jineng/">
            Java — Java程序员应该掌握的十项技能
            <small>01 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/jquery/2015/08/01/jQuery-caozuo-select/">
            jQuery — jQuery操作select
            <small>01 Aug 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
        Copyright © 2015 <br>
    </div>
  </body>
</html>

