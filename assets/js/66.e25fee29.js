(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{182:function(t,s,e){"use strict";e.r(s);var a=e(0),r=Object(a.a)({},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),t._v(" "),e("p",[t._v("Docker 1.12 "),e("a",{attrs:{href:"https://docs.docker.com/engine/swarm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Swarm mode"),e("OutboundLink")],1),t._v(" 已经内嵌入 Docker 引擎，成为了 docker 子命令 "),e("code",[t._v("docker swarm")]),t._v("。请注意与旧的 "),e("code",[t._v("Docker Swarm")]),t._v(" 区分开来。")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),e("p",[e("code",[t._v("Swarm")]),t._v(" 是使用 "),e("a",{attrs:{href:"https://github.com/docker/swarmkit/",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("SwarmKit")]),e("OutboundLink")],1),t._v(" 构建的 Docker 引擎内置（原生）的集群管理和编排工具。")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),e("p",[t._v("来自 Docker 官网的这张图片形象的展示了集群中管理节点与工作节点的关系。")]),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),e("p",[t._v("来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。")]),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),e("p",[t._v("阅读 "),e("a",{attrs:{href:"https://yeasy.gitbooks.io/docker_practice/swarm_mode/overview.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("基本概念"),e("OutboundLink")],1),t._v(" 一节我们知道 "),e("code",[t._v("Swarm")]),t._v(" 集群由 "),e("strong",[t._v("管理节点")]),t._v(" 和 "),e("strong",[t._v("工作节点")]),t._v(" 组成。本节我们来创建一个包含一个管理节点和两个工作节点的最小 "),e("code",[t._v("Swarm")]),t._v(" 集群。")]),t._v(" "),t._m(17),t._v(" "),e("p",[t._v("在 "),e("a",{attrs:{href:"https://yeasy.gitbooks.io/docker_practice/machine",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Docker Machine")]),e("OutboundLink")],1),t._v(" 一节中我们了解到 "),e("code",[t._v("Docker Machine")]),t._v(" 可以在数秒内创建一个虚拟的 Docker 主机，下面我们使用它来创建三个 Docker 主机，并加入到集群中。")]),t._v(" "),e("p",[t._v("我们首先创建一个 Docker 主机作为管理节点。")]),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),t._m(30),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),t._m(35),e("p",[t._v("现在我们使用浏览器，输入任意节点 IP ,即可看到 nginx 默认页面。")]),t._v(" "),t._m(36),t._v(" "),t._m(37),t._v(" "),t._m(38),t._m(39),t._v(" "),t._m(40),t._m(41),t._v(" "),t._m(42),t._m(43),t._v(" "),t._m(44),t._v(" "),e("p",[t._v("当业务处于高峰期时，我们需要扩展服务运行的容器数量。")]),t._v(" "),t._m(45),e("p",[t._v("当业务平稳时，我们需要减少服务运行的容器数量。")]),t._v(" "),t._m(46),t._m(47),t._v(" "),t._m(48),t._v(" "),t._m(49),t._m(50),t._v(" "),t._m(51),t._v(" "),t._m(52),t._v(" "),t._m(53),t._v(" "),t._m(54),t._m(55),t._v(" "),t._m(56),t._v(" "),t._m(57),t._v(" "),t._m(58),t._v(" "),t._m(59),t._m(60),t._v(" "),t._m(61),t._v(" "),t._m(62),t._v(" "),t._m(63),t._v(" "),t._m(64),t._m(65),t._v(" "),t._m(66),t._v(" "),t._m(67),t._m(68),t._v(" "),t._m(69),t._v(" "),t._m(70),t._v(" "),t._m(71),t._v(" "),t._m(72),t._v(" "),t._m(73),t._v(" "),t._m(74),t._v(" "),t._m(75),t._v(" "),t._m(76),t._v(" "),t._m(77),t._m(78),t._v(" "),t._m(79),t._v(" "),t._m(80),t._m(81),t._v(" "),e("p",[t._v("创建服务相关命令已经在前边章节进行了介绍，这里直接列出命令。")]),t._v(" "),t._m(82),t._m(83),t._v(" "),t._m(84),e("p",[t._v("查看服务")]),t._v(" "),t._m(85),t._m(86),t._v(" "),t._m(87),t._v(" "),t._m(88),t._v(" "),e("p",[t._v("在动态的、大规模的分布式集群上，管理和分发配置文件也是很重要的工作。传统的配置文件分发方式（如配置文件放入镜像中，设置环境变量，volume 动态挂载等）都降低了镜像的通用性。")]),t._v(" "),t._m(89),t._v(" "),t._m(90),t._v(" "),t._m(91),t._v(" "),t._m(92),t._v(" "),t._m(93),t._v(" "),t._m(94),t._m(95),t._v(" "),t._m(96),t._v(" "),t._m(97),t._m(98),t._v(" "),t._m(99),t._v(" "),t._m(100),t._m(101),t._v(" "),t._m(102),t._m(103),t._v(" "),e("p",[t._v("经过测试，redis 可以正常使用。")]),t._v(" "),t._m(104),t._v(" "),t._m(105),t._v(" "),e("p",[t._v("在 "),e("a",{attrs:{href:"https://yeasy.gitbooks.io/docker_practice/swarm_mode/deploy.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("部署服务"),e("OutboundLink")],1),t._v(" 一节中我们使用 "),e("code",[t._v("nginx:1.13.7-alpine")]),t._v(" 镜像部署了一个名为 "),e("code",[t._v("nginx")]),t._v(" 的服务。")]),t._v(" "),t._m(106),t._v(" "),e("p",[t._v("你可能会想到，先停止原来的服务，再使用新镜像部署一个服务，不就完成服务的 “升级” 了吗。")]),t._v(" "),e("p",[t._v("这样做的弊端很明显，如果新部署的服务出现问题，原来的服务删除之后，很难恢复，那么在 Swarm mode 中到底该如何对服务进行滚动升级呢？")]),t._v(" "),t._m(107),t._v(" "),t._m(108),t._m(109),t._v(" "),t._m(110),t._v(" "),t._m(111),t._v(" "),t._m(112),t._v(" "),t._m(113),t._v(" "),t._m(114),t._v(" "),t._m(115),t._m(116),t._v(" "),t._m(117),e("p",[t._v("结果的输出详细记录了服务的部署、滚动升级、回退的过程。")])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"swarm-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#swarm-mode","aria-hidden":"true"}},[this._v("#")]),this._v(" Swarm mode")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("Swarm mode")]),this._v(" 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 "),s("code",[this._v("Swarm")]),this._v(" 集群具备与 Mesos、Kubernetes 竞争的实力。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"基本概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本概念","aria-hidden":"true"}},[this._v("#")]),this._v(" 基本概念")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("Swarm")]),this._v(" 集群之前需要了解以下几个概念。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#节点","aria-hidden":"true"}},[this._v("#")]),this._v(" 节点")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("运行 Docker 的主机可以主动初始化一个 "),e("code",[t._v("Swarm")]),t._v(" 集群或者加入一个已存在的 "),e("code",[t._v("Swarm")]),t._v(" 集群，这样这个运行 Docker 的主机就成为一个 "),e("code",[t._v("Swarm")]),t._v(" 集群的节点 ("),e("code",[t._v("node")]),t._v(") 。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("节点分为管理 ("),s("code",[this._v("manager")]),this._v(") 节点和工作 ("),s("code",[this._v("worker")]),this._v(") 节点。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("管理节点用于 "),e("code",[t._v("Swarm")]),t._v(" 集群的管理，"),e("code",[t._v("docker swarm")]),t._v(" 命令基本只能在管理节点执行（节点退出集群命令 "),e("code",[t._v("docker swarm leave")]),t._v(" 可以在工作节点执行）。一个 "),e("code",[t._v("Swarm")]),t._v(" 集群可以有多个管理节点，但只有一个管理节点可以成为 "),e("code",[t._v("leader")]),t._v("，"),e("code",[t._v("leader")]),t._v(" 通过 "),e("code",[t._v("raft")]),t._v(" 协议实现。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("工作节点是任务执行节点，管理节点将服务 ("),s("code",[this._v("service")]),this._v(") 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://docs.docker.com/engine/swarm/images/swarm-diagram.png",alt:"img"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"服务和任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务和任务","aria-hidden":"true"}},[this._v("#")]),this._v(" 服务和任务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("任务 （"),s("code",[this._v("Task")]),this._v("）是 "),s("code",[this._v("Swarm")]),this._v(" 中的最小的调度单位，目前来说就是一个单一的容器。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("服务 （"),s("code",[this._v("Services")]),this._v("） 是指一组任务的集合，服务定义了任务的属性。服务有两种模式：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("code",[this._v("replicated services")]),this._v(" 按照一定规则在各个工作节点上运行指定个数的任务。")]),this._v(" "),s("li",[s("code",[this._v("global services")]),this._v(" 每个工作节点上运行一个任务")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("两种模式通过 "),s("code",[this._v("docker service create")]),this._v(" 的 "),s("code",[this._v("--mode")]),this._v(" 参数指定。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://docs.docker.com/engine/swarm/images/services-diagram.png",alt:"img"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"创建-swarm-集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-swarm-集群","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 Swarm 集群")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"初始化集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#初始化集群","aria-hidden":"true"}},[this._v("#")]),this._v(" 初始化集群")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker-machine create -d virtualbox manager\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们使用 "),s("code",[this._v("docker swarm init")]),this._v(" 在管理节点初始化一个 "),s("code",[this._v("Swarm")]),this._v(" 集群。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker-machine "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" manager\n\ndocker@manager:~$ docker swarm init --advertise-addr 192.168.99.100\nSwarm initialized: current node "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dxn1zf6l61qsb1josjja83ngz"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" is now a manager.\n\nTo "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" a worker to this swarm, run the following command:\n\n    docker swarm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nTo "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" a manager to this swarm, run "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'docker swarm join-token manager'")]),t._v(" and follow the instructions.\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("如果你的 Docker 主机有多个网卡，拥有多个 IP，必须使用 "),s("code",[this._v("--advertise-addr")]),this._v(" 指定 IP。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("执行 "),s("code",[this._v("docker swarm init")]),this._v(" 命令的节点自动成为管理节点。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"增加工作节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#增加工作节点","aria-hidden":"true"}},[this._v("#")]),this._v(" 增加工作节点")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("上一步我们初始化了一个 "),s("code",[this._v("Swarm")]),this._v(" 集群，拥有了一个管理节点，下面我们继续创建两个 Docker 主机作为工作节点，并加入到集群中。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker-machine create -d virtualbox worker1\n\n$ docker-machine "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" worker1\n\ndocker@worker1:~$ docker swarm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nThis node joined a swarm as a worker.\n$ docker-machine create -d virtualbox worker2\n\n$ docker-machine "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" worker2\n\ndocker@worker1:~$ docker swarm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nThis node joined a swarm as a worker.\n")])])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("blockquote",[e("p",[t._v("注意：一些细心的读者可能通过 "),e("code",[t._v("docker-machine create --help")]),t._v(" 查看到 "),e("code",[t._v("--swarm*")]),t._v(" 等一系列参数。该参数是用于旧的 "),e("code",[t._v("Docker Swarm")]),t._v(",与本章所讲的 "),e("code",[t._v("Swarm mode")]),t._v(" 没有关系。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"查看集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看集群","aria-hidden":"true"}},[this._v("#")]),this._v(" 查看集群")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("经过上边的两步，我们已经拥有了一个最小的 "),s("code",[this._v("Swarm")]),this._v(" 集群，包含一个管理节点和两个工作节点。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在管理节点使用 "),s("code",[this._v("docker node ls")]),this._v(" 查看集群。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker node "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\nID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"部署服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 部署服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们使用 "),s("code",[this._v("docker service")]),this._v(" 命令来管理 "),s("code",[this._v("Swarm")]),this._v(" 集群中的服务，该命令只能在管理节点运行。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"新建服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新建服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 新建服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在我们在上一节创建的 "),s("code",[this._v("Swarm")]),this._v(" 集群中运行一个名为 "),s("code",[this._v("nginx")]),this._v(" 服务。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" create --replicas 3 -p 80:80 --name nginx nginx:1.13.7-alpine\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"查看服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 查看服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker service ls")]),this._v(" 来查看当前 "),s("code",[this._v("Swarm")]),this._v(" 集群运行的服务。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          3/3                 nginx:1.13.7-alpine   *:80-"),s("span",{pre:!0,attrs:{class:"token operator"}},[this._v(">")]),this._v("80/tcp\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker service ps")]),this._v(" 来查看某个服务的详情。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ps")]),this._v(" nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker service logs")]),this._v(" 来查看某个服务的日志。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 10.255.0.4 - - "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("25/Nov/2017:02:10:30 +0000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" 200 612 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\nnginx.3.36wmpiv7gmfo@swarm3    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 10.255.0.4 - - "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("25/Nov/2017:02:10:30 +0000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET /favicon.ico HTTP/1.1"')]),t._v(" 404 169 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\nnginx.3.36wmpiv7gmfo@swarm3    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 2017/11/25 02:10:30 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("error"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" 5"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.102"')]),t._v("\nnginx.1.pjfzd39buzlt@swarm2    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 10.255.0.2 - - "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("25/Nov/2017:02:10:26 +0000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" 200 612 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\nnginx.1.pjfzd39buzlt@swarm2    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 10.255.0.2 - - "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("25/Nov/2017:02:10:27 +0000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET /favicon.ico HTTP/1.1"')]),t._v(" 404 169 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\nnginx.1.pjfzd39buzlt@swarm2    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" 2017/11/25 02:10:27 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("error"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" 5"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.101"')]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"服务伸缩"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务伸缩","aria-hidden":"true"}},[this._v("#")]),this._v(" 服务伸缩")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们可以使用 "),s("code",[this._v("docker service scale")]),this._v(" 对一个服务运行的容器数量进行伸缩。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" scale nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[this._v("=")]),this._v("5\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" scale nginx"),s("span",{pre:!0,attrs:{class:"token operator"}},[this._v("=")]),this._v("2\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"删除服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 删除服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker service rm")]),this._v(" 来从 "),s("code",[this._v("Swarm")]),this._v(" 集群移除某个服务。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("rm")]),this._v(" nginx\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"在-swarm-集群中使用-compose-文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-swarm-集群中使用-compose-文件","aria-hidden":"true"}},[this._v("#")]),this._v(" 在 Swarm 集群中使用 compose 文件")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("正如之前使用 "),e("code",[t._v("docker-compose.yml")]),t._v(" 来一次配置、启动多个容器，在 "),e("code",[t._v("Swarm")]),t._v(" 集群中也可以使用 "),e("code",[t._v("compose")]),t._v("文件 （"),e("code",[t._v("docker-compose.yml")]),t._v("） 来配置、启动多个服务。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("上一节中，我们使用 "),s("code",[this._v("docker service create")]),this._v(" 一次只能部署一个服务，使用 "),s("code",[this._v("docker-compose.yml")]),this._v(" 我们可以一次启动多个关联的服务。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们以在 "),s("code",[this._v("Swarm")]),this._v(" 集群中部署 "),s("code",[this._v("WordPress")]),this._v(" 为例进行说明。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("wordpress")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token datetime number"}},[t._v("80:80")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" overlay\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WORDPRESS_DB_HOST")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" db"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WORDPRESS_DB_USER")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WORDPRESS_DB_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" replicated\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" overlay\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" db"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/mysql\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MYSQL_ROOT_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" somewordpress\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MYSQL_DATABASE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MYSQL_USER")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MYSQL_PASSWORD")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" wordpress\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("placement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("constraints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("node.role == manager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("visualizer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dockersamples/visualizer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("stable\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stop_grace_period")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1m30s\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("placement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("constraints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("node.role == manager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("db-data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("overlay")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在 "),s("code",[this._v("Swarm")]),this._v(" 集群管理节点新建该文件，其中的 "),s("code",[this._v("visualizer")]),this._v(" 服务提供一个可视化页面，我们可以从浏览器中很直观的查看集群中各个服务的运行节点。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在 "),s("code",[this._v("Swarm")]),this._v(" 集群中使用 "),s("code",[this._v("docker-compose.yml")]),this._v(" 我们用 "),s("code",[this._v("docker stack")]),this._v(" 命令，下面我们对该命令进行详细讲解。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"部署服务-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署服务-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 部署服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("部署服务使用 "),s("code",[this._v("docker stack deploy")]),this._v("，其中 "),s("code",[this._v("-c")]),this._v(" 参数指定 compose 文件名。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker stack deploy -c docker-compose.yml wordpress\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在我们打开浏览器输入 "),s("code",[this._v("任一节点IP:8080")]),this._v(" 即可看到各节点运行状态。如下图所示：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://yeasy.gitbooks.io/docker_practice/swarm_mode/image/wordpress.png",alt:"img"}})])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("在浏览器新的标签页输入 "),e("code",[t._v("任一节点IP")]),t._v(" 即可看到 "),e("code",[t._v("WordPress")]),t._v(" 安装界面，安装完成之后，输入 "),e("code",[t._v("任一节点IP")]),t._v(" 即可看到 "),e("code",[t._v("WordPress")]),t._v(" 页面。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"查看服务-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看服务-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 查看服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker stack "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\nNAME                SERVICES\nwordpress           3\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"移除服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#移除服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 移除服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("要移除服务，使用 "),s("code",[this._v("docker stack down")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker stack down wordpress\nRemoving "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" wordpress_db\nRemoving "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" wordpress_visualizer\nRemoving "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("该命令不会移除服务所使用的 "),s("code",[this._v("数据卷")]),this._v("，如果你想移除数据卷请使用 "),s("code",[this._v("docker volume rm")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"在-swarm-集群中管理敏感数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-swarm-集群中管理敏感数据","aria-hidden":"true"}},[this._v("#")]),this._v(" 在 Swarm 集群中管理敏感数据")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在动态的、大规模的分布式集群上，管理和分发 "),s("code",[this._v("密码")]),this._v("、"),s("code",[this._v("证书")]),this._v(" 等敏感信息是极其重要的工作。传统的密钥分发方式（如密钥放入镜像中，设置环境变量，volume 动态挂载等）都存在着潜在的巨大的安全风险。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Docker 目前已经提供了 "),s("code",[this._v("secrets")]),this._v(" 管理功能，用户可以在 Swarm 集群中安全地管理密码、密钥证书等敏感数据，并允许在多个 Docker 容器实例之间共享访问指定的敏感数据。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("注意： "),s("code",[this._v("secret")]),this._v(" 也可以在 "),s("code",[this._v("Docker Compose")]),this._v(" 中使用。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们可以用 "),s("code",[this._v("docker secret")]),this._v(" 命令来管理敏感信息。接下来我们在上面章节中创建好的 Swarm 集群中介绍该命令的使用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这里我们以在 Swarm 集群中部署 "),s("code",[this._v("mysql")]),this._v(" 和 "),s("code",[this._v("wordpress")]),this._v(" 服务为例。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建-secret"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-secret","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 secret")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们使用 "),s("code",[this._v("docker secret create")]),this._v(" 命令以管道符的形式创建 "),s("code",[this._v("secret")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ openssl rand -base64 20 "),s("span",{pre:!0,attrs:{class:"token operator"}},[this._v("|")]),this._v(" docker secret create mysql_password -\n\n$ openssl rand -base64 20 "),s("span",{pre:!0,attrs:{class:"token operator"}},[this._v("|")]),this._v(" docker secret create mysql_root_password -\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"查看-secret"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-secret","aria-hidden":"true"}},[this._v("#")]),this._v(" 查看 secret")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker secret ls")]),this._v(" 命令来查看 "),s("code",[this._v("secret")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker secret "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        41 seconds ago      41 seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   12 seconds ago      12 seconds ago\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建-mysql-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-mysql-服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 MySQL 服务")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker network create -d overlay mysql_private\n\n$ docker "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create \\\n     --name mysql \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --mount type"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("volume,source"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mydata,destination"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/var/lib/mysql \\\n     --secret source"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql_root_password,target"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql_root_password \\\n     --secret source"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql_password,target"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql_password \\\n     -e MYSQL_ROOT_PASSWORD_FILE"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/run/secrets/mysql_root_password"')]),t._v(" \\\n     -e MYSQL_PASSWORD_FILE"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/run/secrets/mysql_password"')]),t._v(" \\\n     -e MYSQL_USER"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wordpress"')]),t._v(" \\\n     -e MYSQL_DATABASE"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wordpress"')]),t._v(" \\\n     mysql:latest\n")])])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("如果你没有在 "),e("code",[t._v("target")]),t._v(" 中显式的指定路径时，"),e("code",[t._v("secret")]),t._v(" 默认通过 "),e("code",[t._v("tmpfs")]),t._v(" 文件系统挂载到容器的 "),e("code",[t._v("/run/secrets")]),t._v(" 目录中。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ docker "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" create \\\n     --name wordpress \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --publish target"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("30000,port"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("80 \\\n     --mount type"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("volume,source"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("wpdata,destination"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/var/www/html \\\n     --secret source"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql_password,target"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("wp_db_password,mode"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("0400 \\\n     -e WORDPRESS_DB_USER"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wordpress"')]),t._v(" \\\n     -e WORDPRESS_DB_PASSWORD_FILE"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/run/secrets/wp_db_password"')]),t._v(" \\\n     -e WORDPRESS_DB_HOST"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql:3306"')]),t._v(" \\\n     -e WORDPRESS_DB_NAME"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wordpress"')]),t._v(" \\\n     wordpress:latest\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  1/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  1/1       wordpress:latest\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在浏览器访问 "),s("code",[this._v("IP:30000")]),this._v("，即可开始 "),s("code",[this._v("WordPress")]),this._v(" 的安装与使用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("通过以上方法，我们没有像以前通过设置环境变量来设置 MySQL 密码， 而是采用 "),s("code",[this._v("docker secret")]),this._v(" 来设置密码，防范了密码泄露的风险。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"在-swarm-集群中管理配置数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-swarm-集群中管理配置数据","aria-hidden":"true"}},[this._v("#")]),this._v(" 在 Swarm 集群中管理配置数据")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在 Docker 17.06 以上版本中，Docker 新增了 "),s("code",[this._v("docker config")]),this._v(" 子命令来管理集群中的配置信息，以后你无需将配置文件放入镜像或挂载到容器中就可实现对服务的配置。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("注意："),s("code",[this._v("config")]),this._v(" 仅能在 Swarm 集群中使用。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这里我们以在 Swarm 集群中部署 "),s("code",[this._v("redis")]),this._v(" 服务为例。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建-config"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-config","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 config")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("新建 "),s("code",[this._v("redis.conf")]),this._v(" 文件")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("port 6380\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("此项配置 Redis 监听 "),s("code",[this._v("6380")]),this._v(" 端口")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们使用 "),s("code",[this._v("docker config create")]),this._v(" 命令创建 "),s("code",[this._v("config")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker config create redis.conf redis.conf\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"查看-config"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-config","aria-hidden":"true"}},[this._v("#")]),this._v(" 查看 config")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用 "),s("code",[this._v("docker config ls")]),this._v(" 命令来查看 "),s("code",[this._v("config")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker config "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          4 seconds ago       4 seconds ago\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建-redis-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建-redis-服务","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建 redis 服务")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" create \\\n     --name redis \\\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[this._v("# --config source=redis.conf,target=/etc/redis.conf \\")]),this._v("\n     --config redis.conf \\\n     -p 6379:6380 \\\n     redis:latest \\\n     redis-server /redis.conf\n")])])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("如果你没有在 "),e("code",[t._v("target")]),t._v(" 中显式的指定路径时，默认的 "),e("code",[t._v("redis.conf")]),t._v(" 以 "),e("code",[t._v("tmpfs")]),t._v(" 文件系统挂载到容器的 "),e("code",[t._v("/config.conf")]),t._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("以前我们通过监听主机目录来配置 Redis，就需要在集群的每个节点放置该文件，如果采用 "),s("code",[this._v("docker config")]),this._v("来管理服务的配置信息，我们只需在集群中的管理节点创建 "),s("code",[this._v("config")]),this._v("，当部署服务时，集群会自动的将配置文件分发到运行服务的各个节点中，大大降低了配置信息的管理和分发难度。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"swarm-mode-与滚动升级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#swarm-mode-与滚动升级","aria-hidden":"true"}},[this._v("#")]),this._v(" SWarm mode 与滚动升级")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在我们想要将 "),s("code",[this._v("NGINX")]),this._v(" 版本升级到 "),s("code",[this._v("1.13.12")]),this._v("，那么在 Swarm mode 中如何升级服务呢？")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("答案就是使用 "),s("code",[this._v("docker service update")]),this._v(" 命令。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" update \\\n    --image nginx:1.13.12-alpine \\\n    nginx\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("以上命令使用 "),s("code",[this._v("--image")]),this._v(" 选项更新了服务的镜像。当然我们也可以使用 "),s("code",[this._v("docker service update")]),this._v(" 更新任意的配置。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("--secret-add")]),this._v(" 选项可以增加一个密钥")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("--secret-rm")]),this._v(" 选项可以删除一个密钥")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("更多选项可以通过 "),s("code",[this._v("docker service update -h")]),this._v(" 命令查看。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"服务回退"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务回退","aria-hidden":"true"}},[this._v("#")]),this._v(" 服务回退")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在假设我们发现 "),s("code",[this._v("nginx")]),this._v(" 服务的镜像升级到 "),s("code",[this._v("nginx:1.13.12-alpine")]),this._v(" 出现了一些问题，我们可以使用命令一键回退。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" rollback nginx\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在使用 "),s("code",[this._v("docker service ps")]),this._v(" 命令查看 "),s("code",[this._v("nginx")]),this._v(" 服务详情。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("service")]),this._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[this._v("ps")]),this._v(" nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         \\_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown 2 minutes ago\ni7ynkbg6ybq5         \\_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown 2 minutes ago\n")])])])}],!1,null,null,null);s.default=r.exports}}]);